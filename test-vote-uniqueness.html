<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Unicit√© des Votes par Candidat et Cat√©gorie</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .candidate-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .vote-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .vote-btn:hover {
            background: #2563eb;
        }
        .vote-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .voted {
            background: #10b981;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .candidate-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .category-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Test - Unicit√© des Votes par Candidat et Cat√©gorie</h1>
    
    <div class="test-container">
        <h2>Objectif du Test</h2>
        <p>V√©rifier que chaque bouton "Voter" est associ√© √† un candidat unique dans une cat√©gorie sp√©cifique, avec des identifiants uniques et une validation appropri√©e.</p>
    </div>

    <div class="test-container">
        <h2>Contr√¥les de Test</h2>
        <button onclick="runAllTests()" class="vote-btn">Lancer Tous les Tests</button>
        <button onclick="clearLog()" class="vote-btn">Effacer les Logs</button>
        <button onclick="resetVotes()" class="vote-btn">R√©initialiser les Votes</button>
    </div>

    <div class="test-container">
        <h2>Logs de Test</h2>
        <div id="log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>Candidats de Test</h2>
        <div id="candidates-container"></div>
    </div>

    <script>
        // Donn√©es de test avec candidats de diff√©rentes cat√©gories
        const testCandidates = [
            {
                id: 1,
                name: "Fouta Tourisme",
                category: "Meilleur Guide Touristique de l'ann√©e",
                votes: 0,
                isVoted: false
            },
            {
                id: 2,
                name: "Tibou Bah",
                category: "Meilleur Guide Touristique de l'ann√©e",
                votes: 0,
                isVoted: false
            },
            {
                id: 4,
                name: "H√¥tel Onomo",
                category: "Meilleure √âquipe en Housekeeping de l'ann√©e",
                votes: 0,
                isVoted: false
            },
            {
                id: 8,
                name: "Noom H√¥tel",
                category: "Meilleure Brigade de Cuisine de l'ann√©e",
                votes: 0,
                isVoted: false
            }
        ];

        let candidates = [...testCandidates];
        let votingInProgress = new Set();

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.body.insertBefore(statusDiv, document.querySelector('.test-container'));
            setTimeout(() => statusDiv.remove(), 3000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function resetVotes() {
            candidates = [...testCandidates];
            votingInProgress.clear();
            renderCandidates();
            log('üîÑ Votes r√©initialis√©s');
            showStatus('Votes r√©initialis√©s', 'success');
        }

        function renderCandidates() {
            const container = document.getElementById('candidates-container');
            container.innerHTML = '';

            candidates.forEach(candidate => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.innerHTML = `
                    <div class="candidate-info">
                        <div>
                            <h3>${candidate.name} (ID: ${candidate.id})</h3>
                            <span class="category-badge">${candidate.category}</span>
                        </div>
                        <div>
                            <span>Votes: ${candidate.votes}</span>
                        </div>
                    </div>
                    <div>
                        <button 
                            id="vote-btn-${candidate.id}-${candidate.category.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}"
                            data-candidate-id="${candidate.id}"
                            data-candidate-name="${candidate.name}"
                            data-candidate-category="${candidate.category}"
                            onclick="testVote(${candidate.id}, '${candidate.name}', '${candidate.category}')"
                            ${candidate.isVoted || votingInProgress.has(candidate.id) ? 'disabled' : ''}
                            class="vote-btn ${candidate.isVoted ? 'voted' : votingInProgress.has(candidate.id) ? 'voting' : ''}"
                        >
                            ${candidate.isVoted ? '‚úÖ Vot√©' : votingInProgress.has(candidate.id) ? '‚è≥ En cours...' : 'üó≥Ô∏è Voter'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function testVote(candidateId, candidateName, candidateCategory) {
            log(`üñ±Ô∏è Clic sur le bouton de vote pour candidat ID: ${candidateId}, Nom: ${candidateName}, Cat√©gorie: ${candidateCategory}`);
            
            // Validation basique
            if (!candidateId || !candidateName || !candidateCategory) {
                log(`‚ùå Donn√©es manquantes: ID=${candidateId}, Nom=${candidateName}, Cat√©gorie=${candidateCategory}`);
                showStatus('Erreur: Donn√©es manquantes', 'error');
                return;
            }
            
            // Trouver le candidat
            const candidate = candidates.find(c => c.id === candidateId);
            if (!candidate) {
                log(`‚ùå Candidat non trouv√© avec ID: ${candidateId}`);
                showStatus('Erreur: Candidat non trouv√©', 'error');
                return;
            }
            
            // V√©rifier la correspondance candidat-cat√©gorie
            if (candidate.category !== candidateCategory) {
                log(`‚ùå Correspondance candidat-cat√©gorie incorrecte:`);
                log(`   Candidat ID: ${candidateId}`);
                log(`   Candidat Nom: ${candidate.name}`);
                log(`   Candidat Cat√©gorie: ${candidate.category}`);
                log(`   Cat√©gorie Vote: ${candidateCategory}`);
                showStatus('Erreur: Correspondance candidat-cat√©gorie incorrecte', 'error');
                return;
            }
            
            // V√©rifier si d√©j√† vot√©
            if (candidate.isVoted) {
                log(`‚ö†Ô∏è Candidat d√©j√† vot√©: ${candidate.name}`);
                showStatus('Vous avez d√©j√† vot√© pour ce candidat', 'warning');
                return;
            }
            
            // V√©rifier si vote en cours
            if (votingInProgress.has(candidateId)) {
                log(`‚ö†Ô∏è Vote d√©j√† en cours pour: ${candidate.name}`);
                showStatus('Un vote est d√©j√† en cours pour ce candidat', 'warning');
                return;
            }

            log(`‚úÖ Vote autoris√© pour: ${candidate.name} (${candidate.category})`);
            
            // Marquer comme en cours
            votingInProgress.add(candidateId);
            renderCandidates();
            
            // Simuler un d√©lai de traitement
            setTimeout(() => {
                // Mettre √† jour le candidat
                const candidateIndex = candidates.findIndex(c => c.id === candidateId);
                if (candidateIndex !== -1) {
                    candidates[candidateIndex].votes += 1;
                    candidates[candidateIndex].isVoted = true;
                }
                
                // Retirer du processus en cours
                votingInProgress.delete(candidateId);
                
                // Sauvegarder dans localStorage
                localStorage.setItem('hag_test_votes', JSON.stringify(candidates));
                
                log(`‚úÖ Vote enregistr√© pour: ${candidate.name} (${candidate.category}) - Total votes: ${candidates[candidateIndex].votes}`);
                showStatus(`Vote enregistr√© pour ${candidate.name}`, 'success');
                
                renderCandidates();
            }, 1000);
        }

        function runAllTests() {
            log('üß™ D√©but des tests d\'unicit√© des votes...');
            
            // Test 1: V√©rifier les identifiants uniques
            log('Test 1: V√©rification des identifiants uniques des boutons');
            const buttons = document.querySelectorAll('[id^="vote-btn-"]');
            const buttonIds = Array.from(buttons).map(btn => btn.id);
            const uniqueIds = new Set(buttonIds);
            
            if (buttonIds.length === uniqueIds.size) {
                log('‚úÖ Tous les boutons ont des identifiants uniques');
            } else {
                log('‚ùå Des identifiants de boutons sont dupliqu√©s');
            }
            
            // Test 2: V√©rifier la correspondance candidat-cat√©gorie
            log('Test 2: V√©rification de la correspondance candidat-cat√©gorie');
            let allMatches = true;
            candidates.forEach(candidate => {
                const button = document.querySelector(`[data-candidate-id="${candidate.id}"]`);
                if (button) {
                    const buttonCategory = button.getAttribute('data-candidate-category');
                    if (candidate.category === buttonCategory) {
                        log(`‚úÖ Correspondance OK: ${candidate.name} - ${candidate.category}`);
                    } else {
                        log(`‚ùå Correspondance KO: ${candidate.name} - Attendu: ${candidate.category}, Re√ßu: ${buttonCategory}`);
                        allMatches = false;
                    }
                }
            });
            
            if (allMatches) {
                log('‚úÖ Toutes les correspondances candidat-cat√©gorie sont correctes');
            } else {
                log('‚ùå Certaines correspondances candidat-cat√©gorie sont incorrectes');
            }
            
            // Test 3: V√©rifier l'unicit√© des candidats par cat√©gorie
            log('Test 3: V√©rification de l\'unicit√© des candidats par cat√©gorie');
            const candidatesByCategory = {};
            candidates.forEach(candidate => {
                if (!candidatesByCategory[candidate.category]) {
                    candidatesByCategory[candidate.category] = [];
                }
                candidatesByCategory[candidate.category].push(candidate);
            });
            
            let uniqueCandidates = true;
            Object.keys(candidatesByCategory).forEach(category => {
                const categoryCandidates = candidatesByCategory[category];
                const candidateIds = categoryCandidates.map(c => c.id);
                const uniqueIds = new Set(candidateIds);
                
                if (candidateIds.length === uniqueIds.size) {
                    log(`‚úÖ Cat√©gorie "${category}": ${categoryCandidates.length} candidats uniques`);
                } else {
                    log(`‚ùå Cat√©gorie "${category}": candidats dupliqu√©s d√©tect√©s`);
                    uniqueCandidates = false;
                }
            });
            
            if (uniqueCandidates) {
                log('‚úÖ Tous les candidats sont uniques dans leurs cat√©gories respectives');
            } else {
                log('‚ùå Des candidats dupliqu√©s ont √©t√© d√©tect√©s');
            }
            
            log('üß™ Tests termin√©s');
            showStatus('Tests termin√©s - V√©rifiez les logs', 'success');
        }

        // Charger les votes sauvegard√©s au d√©marrage
        function loadSavedVotes() {
            const savedVotes = localStorage.getItem('hag_test_votes');
            if (savedVotes) {
                try {
                    candidates = JSON.parse(savedVotes);
                    log('üìÅ Votes sauvegard√©s charg√©s');
                } catch (error) {
                    log('‚ùå Erreur lors du chargement des votes sauvegard√©s');
                }
            }
        }

        // Initialiser la page
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedVotes();
            renderCandidates();
            log('üöÄ Page de test initialis√©e');
        });
    </script>
</body>
</html>
